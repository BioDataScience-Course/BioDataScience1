---
title: "Test Chi2 d'ind√©pendance"
author: "Guyliann Engels & Philippe Grosjean"
description: "**SDD I Module 8** Comprendre et interpr√©ter le test Chi2 d'ind√©pendance."
tutorial:
  id: "A08Lb_chi2b"
  version: 2.1.0/10
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
BioDataScience1::learnr_setup()
SciViews::R()
```

```{r, echo=FALSE}
BioDataScience1::learnr_banner()
```

```{r, context="server"}
BioDataScience1::learnr_server(input, output, session)
```

------------------------------------------------------------------------

## Objectifs

La loi de distribution du $\chi^2$ peut √™tre utilis√©e pour √©tudier si des d√©pendances existent ou non entre les niveaux de deux variables qualitatives. C'est le test $\chi^2$ d'ind√©pendance. Vos objectifs sont¬†:

-   Comprendre le test d'hypoth√®se de $\chi^2$ d'ind√©pendance pour deux variables qualitatives crois√©es

-   Interpr√©ter correctement un tel test

Vous devez avoir assimil√© la mati√®re du [module 8](https://wp.sciviews.org/sdd-umons/?iframe=wp.sciviews.org/sdd-umons-2020/chi2.html) du cours, en particulier la [section 8.2](https://wp.sciviews.org/sdd-umons/?iframe=wp.sciviews.org/sdd-umons-2020/test-dhypoth%25C3%25A8se.html). Vous devez avoir r√©alis√© le tutoriel `BioDataScience1::run("A08La_chi2")` pr√©alablement. Ce learnr vous sert √† auto-√©valuer vos acquis relatifs au test $\chi^2$ d'ind√©pendance.

## Fumeurs

![](images/smoker.jpg)

Le tabagisme est √©tudi√© chez les adolescents. Voici les r√©sultats d'un sondage sur un √©chantillon al√©atoire parmi la population d'adolescents concern√©s par cette √©tude¬†:

```{r, echo=TRUE}
tabac <- dtx(
  genre        = c("fille",  "gar√ßon", "fille",      "gar√ßon"),
  comportement = c("fumeur", "fumeur", "non fumeur", "non fumeur"),
  freq          = c(11,       22,        28,            19))
tabac_table <- xtabs(data = tabac, freq ~ genre + comportement)
knitr::kable(tabac_table)
```

Vous voulez savoir si la pr√©valence du tabagisme chez les adolescents est d√©pendante ou non du genre. Pour cela, vous consid√©rez la distribution du $\chi^2$.

### Calcul du $\chi^2_{obs}$

Afin de d√©terminer la valeur du $\chi^2_{obs}$, vous commencez par r√©aliser le tableau contenant les fr√©quences th√©oriques sous l'hypoth√®se nulle d'ind√©pendance du tabagisme par rapport au genre (les $\alpha_i$). Faite ce calcul √† la main, en vous aidant √©ventuellement d'une calculette.

```{r}
a <- dtx(
  genre        = c("fille", "garcon"),
  fumeur       = c(16.1, 16.9),
  `non fumeur` = c(22.9, 24.1))
b <- dtx(
  genre        = c("fille", "garcon"),
  fumeur       = c(4.8, 7.6),
  `non fumeur` = c(15.5, 11.9))
c <- dtx(
  genre        = c("fille", "garcon"),
  fumeur       = c(5.9, 9.6),
  `non fumeur` = c(12.8, 10.1))
d <- dtx(
  genre        = c("fille", "garcon"),
  fumeur       = c(12.4, 15.9),
  `non fumeur` = c(26.4, 21.5))
ggtexttable <- ggpubr::ggtexttable
aa <- ggtexttable(a, rows = NULL)
bb <- ggtexttable(b, rows = NULL)
cc <- ggtexttable(c, rows = NULL)
dd <- ggtexttable(d, rows = NULL)
combine_charts(chartlist = list(aa, bb, cc, dd))
```

```{r qu_alpha_i}
question("S√©lectionnez le tableau correspondant aux valeurs de $\\alpha_i$ (vous pouvez utiliser une calculette pour v√©rifier)",
  answer("A", correct = TRUE),
  answer("B"),
  answer("C"),
  answer("D"),
  allow_retry = TRUE,
  incorrect = "Recommencez afin de trouver la bonne r√©ponse",
  correct = "C'est correct ! Ces valeurs correspondent aux totaux des lignes multipli√©s par les totaux des colonnes et divis√©s par le total g√©n√©ral.")
```

Calculez ensuite la valeur du $\chi^2_{obs}$ toujours sous l'hypoth√®se nulle d'ind√©pendance √† l'aide de votre calculette. Pour rappel, le calcul est le suivant¬†:

$$\chi^2_{obs} = \sum_i \frac{(a_i - \alpha_i)^2}{\alpha_i}$$

```{r qu_valeur_chi2}
question("Valeur du $\\chi^2$",
  answer("5.34", correct = TRUE),
  answer("1.85"),
  answer("6.28"),
  answer("3.59"),
  allow_retry = TRUE, random_answer_order = TRUE,
  incorrect = "Recommencez afin de trouver la bonne r√©ponse",
  correct = "C'est correct ! Cette valeur est la somme des a_i moins alpha_i au carr√© divis√©s par les alpha_i.")
```

### Test $\chi^2$ d'ind√©pendance

Continuez le calcul de votre test d'hypoth√®se d'ind√©pendance √† la main en d√©terminant l'aire √† droite d√©limit√©e par la valeur du quantile $\chi^2_{obs}$ calcul√© ci-dessus dans la distribution du $\chi^2$ correspondant √† cette √©tude.

üí¨ **Ce code correspond au snippet `.icproba`** [`.ic` = (d)`i`stribution: `c`hi2].

```{r valeur_chi2_h2, exercise=TRUE}
pchisq(___, df = ___, lower.tail = ___)
```

```{r valeur_chi2_h2-hint-1}
pchisq(___, df = 1, lower.tail = ___)

 #### ATTENTION: Hint suivant = solution !####
```

```{r valeur_chi2_h2-solution}
pchisq(5.34, df = 1, lower.tail = FALSE)
```

```{r valeur_chi2_h2-check}
grade_code("Notez bien que la distribution du Chi^2 correspondante a ici un seul degr√© de libert√©.")
```

```{r qu_interpretation}
quiz(
  question("Rejetez-vous $H_0$ au seuil alpha de 5% ?",
    answer("oui", correct = TRUE),
    answer("non"),
    allow_retry = TRUE,
    incorrect = "Recommencez afin de trouver la bonne r√©ponse",
    correct = "C'est correct !"),
  question("Toujours au seuil alpha de 5%, y-a-t'il d√©pendance ou ind√©pendance des deux variables ?",
    answer("D√©pendance des deux variables", correct = TRUE),
    answer("Ind√©pendance des deux variables"),
    allow_retry = TRUE,
    incorrect = "Recommencez afin de trouver la bonne r√©ponse",
    correct = "C'est correct ! Vous rejetez H0 et cela signifie ici d√©pendance entre le genre et la pr√©valence du tabagisme chez ces adolescents, en l'occurence, les gar√ßons ont plus tendance √† fumer que les filles (vous comparez les fr√©quences observ√©es par rapport aux fr√©quences attendues sous H0 pour le d√©terminer).")
)
```

### Utilisation de `chisq.test()`

Maintenant, calculez le m√™me test d'hypoth√®se, mais avec la fonction d√©di√©e `chisq.test()` dans R sur notre tableau de contingence √† double entr√©e, consid√©rant qu'il est d√©j√† encod√© dans R sous le nom `tabac_table`.

üí¨ **Ce code correspond au snippet `.hcchi2bi`** [`.hc` = `h`ypothesis tests: `c`ontingency].

```{r tabac-prepare}
tabac <- dtx(
  genre        = c("fille",  "gar√ßon", "fille",      "gar√ßon"),
  comportement = c("fumeur", "fumeur", "non fumeur", "non fumeur"),
  freq          = c(11,       22,        28,            19))
tabac_table <- xtabs(data = tabac, freq ~ genre + comportement)
```

```{r chi2_test_h2, exercise=TRUE, exercise.setup = "tabac-prepare"}
(chi2. <- chisq.test(___, correct = FALSE))
cat("Expected frequencies:\n"); chi2.[["expected"]]
```

```{r chi2_test_h2-hint-1}
(chi2. <- chisq.test(TABLE_FREQ, correct = FALSE))
cat("Expected frequencies:\n"); chi2.[["expected"]]

 #### ATTENTION: Hint suivant = solution !####
```

```{r chi2_test_h2-solution}
(chi2. <- chisq.test(tabac_table, correct = FALSE))
cat("Expected frequencies:\n"); chi2.[["expected"]]
```

```{r chi2_test_h2-check}
grade_code("Dor√©navant, le d√©tail du calcul √† la main ne vous est plus utile. Il vous sert seulement dans un premier temps √† comprendre la logique derri√®re le test. Vous pouvez directement utiliser `chisq.test()` en pratique.")
```

V√©rifiez que vous obtenez bien la m√™me valeur que celle que vous aviez calcul√©e √† la main. La fonction `chisq.test()` permet une subtilit√© suppl√©mentaire via la correction de continuit√© de Yates si vous indiquez `correct = TRUE`. *Il est conseill√© d'utiliser cette correction en pratique et elle est activ√©e par d√©faut, donc, si vous ne pr√©cisez pas `correct=` dans l'appel de `chisq.test()`.*

```{r, echo=TRUE}
(chi2. <- chisq.test(tabac_table, correct = TRUE))
cat("Expected frequencies:\n"); chi2.[["expected"]]
```

## Groupes sanguins

![](images/blood.jpg)

Une √©tude de la distribution des diff√©rents groupes sanguins est r√©alis√©e dans trois √©tats am√©ricains¬†: Iowa en vert, Missouri en bleu et Floride en rouge sur la carte ci-dessous.

```{r, fig.align='center', echo=FALSE, message=FALSE, out.width= '80%'}
SciViews::R
usa <- map_data("state")
usa$region <- as.factor(usa$region)
#usa$region
#levels(usa$region)

library(cowplot)
chart(usa, aes(long, lat, group = group)) +
  geom_polygon(fill = "white", colour = "black") +
  geom_polygon(data = filter(usa, region == "florida"),
    aes(long, lat, group = group), fill = "red") +
  geom_polygon(data = filter(usa, region == "missouri"),
    aes(long, lat, group = group), fill = "blue") +
  geom_polygon(data = filter(usa, region == "iowa"),
    aes(long, lat, group = group), fill = "green") +
  theme(axis.line = element_blank(), axis.title = element_blank(),
    axis.text = element_blank(), axis.ticks = element_blank()) +
  coord_quickmap()
```

Voici les r√©sultats de cette √©tude sur un √©chantillon al√©atoire de la population (notez l'utilisation de `xtabs()` ici en avant derni√®re ligne pour cr√©er le tableau de contingence √† double entr√©e √† partir des fr√©quences et qui correspond au snippet `.ectable2f`)¬†:

```{r, echo=TRUE}
blood <- dtx(
  group = c("A", "B", "AB", "O", "A", "B", "AB", "O", "A", "B", "AB", "O"),
  state = c("Floride", "Floride", "Floride", "Floride",
            "Iowa", "Iowa", "Iowa", "Iowa",
            "Missouri", "Missouri", "Missouri", "Missouri"),
  freq  = c(122, 117, 19, 244, 1781, 1351, 289, 3301, 353, 269, 60, 713))
blood_table <- xtabs(data = blood, freq ~ group + state)
knitr::kable(blood_table)
```

Les distributions des groupes sanguins sont-elles identiques dans les trois √©tats √©tudi√©s¬†?

Avant de r√©alisez votre test $\chi^2$ d'ind√©pendance avec R, veuillez indiquer le nombre de degr√© de libert√© de la distribution $\chi^2$ th√©orique associ√©e.

```{r qu_ddl}
question("Nombre de degr√© de libert√© de la distribution du $\\chi^2$.",
  answer("1"),
  answer("2"),
  answer("3"),
  answer("4"), 
  answer("6", correct = TRUE),
  answer("12"),
  allow_retry = TRUE,
  incorrect = "Recommencez afin de trouver la bonne r√©ponse",
  correct = "C'est correct ! Le nombre de degr√©s de libert√©s est le nombre de lignes moins une multipli√© par le nombre de colonnes moins une du tableau de contingence √† double entr√©e, soit ici (3-1) * (4-1) = 6.")
```

Calculez le test $\chi^2$ d'ind√©pendance dans R pour ce jeu de donn√©es directement avec la fonction `chisq.test()` consid√©rant que le tableau de contingence est d√©j√† cr√©√© dans R sous le nom `blood_table`.

üí¨ **Ce code correspond au snippet `.hcchi2bi`.**

```{r blood-prepare}
blood <- dtx(
  group = c("A", "B", "AB", "O", "A", "B", "AB", "O", "A", "B", "AB", "O"),
  state = c("Floride", "Floride", "Floride", "Floride",
            "Iowa", "Iowa", "Iowa", "Iowa",
            "Missouri", "Missouri", "Missouri", "Missouri"),
  freq  = c(122, 117, 19, 244, 1781, 1351, 289, 3301, 353, 269, 60, 713))
blood_table <- xtabs(data = blood, freq ~ group + state)
```

```{r chi_blood_h2, exercise=TRUE, exercise.setup = "blood-prepare"}
(chi2. <- chisq.test(___))
cat("Expected frequencies:\n")
chi2.[["expected"]]
```

```{r chi_blood_h2-hint-1}
(chi2. <- chisq.test(TABLE))
cat("Expected frequencies:\n")
chi2.[["expected"]]
```

```{r chi_blood_h2-solution}
(chi2. <- chisq.test(blood_table))
cat("Expected frequencies:\n")
chi2.[["expected"]]
```

```{r chi_blood_h2-check}
grade_code("Le code est similaire au cas pr√©c√©dent. Pour rappel, ne pas sp√©cifier `correct =` dans `chisq.test()` implique la valeur `TRUE` par d√©faut. Cependant la correction de Yates n'est disponible que pour un tableau 2x2. Donc, cela n'a pas d'effet ici.")
```

```{r qu_interpretation2}
quiz(
  question("Avec un seuil alpha de 5%, rejetez-vous $H_0$ ici ?",
    answer("oui"),
    answer("non", correct = TRUE),
    allow_retry = TRUE,
    incorrect = "Recommencez afin de trouver la bonne r√©ponse",
    correct = "C'est correct !"),
  question("Toujours au seuil alpha de 5%, y-a-t'il d√©pendance ou ind√©pendance des variables ?",
    answer("D√©pendance des variables"),
    answer("Ind√©pendance des variables", correct = TRUE),
    allow_retry = TRUE,
    incorrect = "Recommencez afin de trouver la bonne r√©ponse",
    correct = "C'est correct ! Cela signifie que la distribution des groupes sanguins dans la population am√©ricaine ne diff√®re pas d'un √©tat √† l'autre de mani√®re significative au seuil alpha de 5% (en tous cas pour ces 3 √©tats-l√†).")
)
```

## Conclusion

A l'issue de cette s√©rie d'exercices, vous devriez √™tre √† l'aise avec l'utilisation de la distribution du $\chi^2$ et de ses tests d'hypoth√®se. Vous pouvez maintenant passer √† des applications concr√®tes (assignation GitHub).

```{r comm_noscore, echo=FALSE}
question_text(
  "Laissez-nous vos impressions sur ce learnr",
  answer("", TRUE, message = "Pas de commentaires... C'est bien aussi."),
  incorrect = "Vos commentaires sont enregistr√©s.",
  placeholder = "Entrez vos commentaires ici...",
  allow_retry = TRUE
)
```
