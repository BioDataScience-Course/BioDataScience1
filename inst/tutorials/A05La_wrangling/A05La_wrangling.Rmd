---
title: "Remaniement de données"
author: "Guyliann Engels & Philippe Grosjean"
description: "**SDD I Module 5** Importer et remanier des données dans R."
tutorial:
  id: "A05La_wrangling"
  version: 2.1.0/3
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
    fig_caption: yes
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
BioDataScience1::learnr_setup()
SciViews::R()
library(BioDataScience)

# Dataset
crabs <- read("crabs", package = "MASS", lang = "fr")
```

```{r, echo=FALSE}
BioDataScience1::learnr_banner()
```

```{r, context="server"}
BioDataScience1::learnr_server(input, output, session)
```

------------------------------------------------------------------------

## Objectifs

-   Vérifier l'acquisition des notions relatives aux remaniement des données avec les fonctions `select()`/`fselect()`, `filter()`/`fsubset()`, `mutate()`/`fmutate()`, `group_by()`/`fgroup_by()`, `summarise()`/`fsummarise()`
-   Vérifier l'acquisition des compétences relatives au chaînage des instructions

## Calculer de nouvelles variables

Le remaniement des données est indispensable lors d'une analyse de données. Pour vérifier l'acquisition de ces compétences, le jeu de données sur la biométrie des crabes est employée.

```{r}
SciViews::R
# Importation des données sur la biométrie des crabes
(crabs <- read("crabs", package = "MASS", lang = "fr"))
```

A partir du jeu de données `crabs`, calculez à l'aide de la fonction `fmutate()` :

-   le logarithme (`log()`) de la longueur de la carapace (`length`) des crabes et nommez cette nouvelle variables **length_log**
-   la racine carrée (`sqrt()`) de la largueur de la carapace (`width`) et nommez cette nouvelle variable **width_sqrt**
-   Divisez la variable lobe frontal (`front`) par 1000 et nommez cette nouvelle variable **front_m**

Affichez ensuite les premières lignes du tableau (`head()`). Par défaut, les 6 premières lignes sont affichées)

Vous devez obtenir le tableau ci-dessous :

```{r}
# fmutate
crabs <- fmutate(crabs, 
  length_log = log(length),
  width_sqrt = sqrt(width),
  front_m    = front/1000)
# Visualisation des premières lignes du tableau 
head(crabs)
```

```{r mutate_h3, exercise=TRUE}
# fmutate
___ <- ___(___,
  ___ = ___,
  ___ = ___,
  ___ = ___)
# Visualisation des premières lignes du tableau 
___(___)
```

```{r mutate_h3-hint-1}
# fmutate
DF <- fmutate(___,
  length_log = ___,
  width_sqrt = ___,
  front_m    = ___)
# Visualisation des premières lignes du tableau 
head(___)
```

```{r mutate_h3-hint-2}
# fmutate
crabs <- fmutate(crabs,
  length_log = log(___),
  width_sqrt = sqrt(___),
  front_m    = ___/1000)
# Visualisation des premières lignes du tableau 
head(___)

#### Attention : solution dans le 'hint' suivant! ####
```

```{r mutate_h3-solution}
# fmutate
crabs <- fmutate(crabs,
  length_log = log(length),
  width_sqrt = sqrt(width),
  front_m    = front/1000)
# Visualisation des premières lignes du tableau 
head(crabs)
```

```{r mutate_h3-check}
grade_code("Vous savez maintenant comment calculer de nouvelles variables avec la fonction `fmutate()`.")
```

## Filtrer et sélectionner des données

Reprenons le jeu de données initial sur nos crabes (`crabs`)

```{r}
# Importation des données sur nos crabes
(crabs <- read("crabs", package = "MASS", lang = "fr"))
```

Réalisez les opérations suivantes avec les fonctions `filter()` et `select()` :

-   Retirer la variable index (`index`) du jeu de données
-   Garder uniquement les individus mâles du jeu de données dont la longueur de la carapace est supérieure ou égale à 25 mm (variables `sex` et `length`)
-   Affichez ensuite les premières lignes du tableau (par défaut, les 6 premières lignes sont affichées). Attention ! Comme la fonction que vous utiliserez est non-tidy, il faut collecter le tableau de résultats avant !

Employez le chaînage des instructions au sein d'un pipeline pour résoudre cette exercice.

Vous devez obtenir le tableau ci-dessous :

```{r}
crabs %>.%
  select(., -index) %>.%
  filter(., sex == "M" & length >= 25) %>.%
  collect_dtx(.) %>.%
  head(.)
```

```{r pipe1_h3, exercise=TRUE}
crabs ___
  ___(___, ___) ___
  ___(___, ___ & ___) ___
  ___(___) ___
  ___(___)
```

```{r pipe1_h3-hint-1}
crabs %>.%
  select(___, ___) ___
  filter(___, ___ & ___) ___
  collect_dtx(___) ___
  head(___)
```

```{r pipe1_h3-hint-2}
crabs %>.%
  select(., - ___) %>.%
  filter(___, sex == ___ & length >= ___) ___
collect_dtx(___) ___
  head(___)
```

```{r pipe1_h3-solution}
crabs %>.%
  select(., -index) %>.%
  filter(., sex == "M" & length >= 25) %>.%
  collect_dtx(.) %>.%
  head(.)
```

```{r pipe1_h3-check}
grade_code("Vous maitrisez maintenant la sélection de vos variables avec `select()` et de vos observations avec `filter()`. Ce sont des fonctions tidy, donc, pensez bien à collecter les résultats à la fin avec `collect_dtx()`, ou en assignant avec `%<-%` ou `%->%` !")
```

## Résumer des données

Reprenons le jeu de données initial `crabs`.

```{r}
# Importation des données sur les crabes
(crabs <- read("crabs", package = "MASS", lang = "fr"))
```

Réalisez les opérations suivantes :

-   Sélectionnez les individus dont la longueur (`length`) est strictement supérieur à 25 mm
-   Résumez le jeu de données par le sexe (`sex`) et par la variété (`species`) de *Leptograpsus variegatus*
    -   Calculez la moyenne de la largeur des carapaces (`width`) par groupe
    -   Dénombrez les individus par groupe
-   Assignez le résultat à `crabs2`
-   Formatez votre tableau `crabs2` avec la fonction `kintr::kable()`

Employez le chaînage des opérations au sein d'un pipeline pour résoudre cette exercice.

Vous devez obtenir le tableau ci-dessous :

```{r}
crabs %>.%
  filter(., length > 25) %>.%
  group_by(., sex, species) |> summarise(
    mean   = mean(width),
    number = n()) %->%
  crabs2
knitr::kable(crabs2)
```

```{r pipe2_h3, exercise=TRUE}
crabs ___
  ___(___, ___) ___
  ___(___, ___, ___) ___ ___
    mean   = ___(___),
    number = ___()) ___
  ___
  ___(___)
```

```{r pipe2_h3-hint-1}
crabs %>.%
  filter(___, ___) ___
  group_by(___, ___, ___) ___ summarise(
    mean   = ___(___),
    number = ___()) ___
  ___
kintr::kable(___)
```

```{r pipe2_h3-hint-2}
crabs %>.%
  filter(., length > ___) %>.%
  group_by(., ___, ___) |> summarise(
    mean   = mean(___),
    number = n()) ___
  ___
knitr::kable(___)
```

```{r pipe2_h3-solution}
crabs %>.%
  filter(., length > 25) %>.%
  group_by(., sex, species) |> summarise(
    mean   = mean(width),
    number = n()) %->%
  crabs2
knitr::kable(crabs2)
```

```{r pipe2_h3-check}
grade_code("Vous progressez à grand pas ! Vous savez maintenant résumer vos données avec `group_by()` et `summarise()` et formater vos sorties avec `knitr::kable()`. Très important : utilisez toujours l'assignation alternative `%->%` en fin de pipeline qui utilise des fonctions tidy.")
```

## Conclusion

Bravo ! Vous venez de terminer votre séance d'exercices relative à la manipulation des données.

Vous maîtriser maintenant :

-   les notions relatives aux remaniement des données avec les fonctions `select()`, `filter()`, `mutate()`, `group_by()`, `summarise()`
-   le chaînages des instructions au sein d'un pipeline
-   l'utilisation judicieuse de `%>.%` pour indiquer que l'on passe à l'opération suivante
-   l'utilisation de `|>` pour organiser le code plus complexe au sein d'une même opération (typiquement un `group_by()` suivi d'un `summarise()`)
-   l'assignation alternative `%->%` en fin de pipeline "tidy" pour collecter les résultats dans un tableau (data frame)

```{r comm_noscore, echo=FALSE}
question_text(
  "Laissez-nous vos impressions sur ce learnr",
  answer("", TRUE, message = "Pas de commentaires... C'est bien aussi."),
  incorrect = "Vos commentaires sont enregistrés.",
  placeholder = "Entrez vos commentaires ici...",
  allow_retry = TRUE
)
```
