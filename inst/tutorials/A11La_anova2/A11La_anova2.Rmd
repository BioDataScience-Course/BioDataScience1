---
title: "ANOVA √† 2 facteurs"
author: "Guyliann Engels & Philippe Grosjean"
description: "**SDD I Module 11** Analyse de variance √† deux facteurs, diff√©rents mod√®les."
tutorial:
  id: "A11La_anova2"
  version: 2.0.0/11
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
BioDataScience1::learnr_setup()
SciViews::R()
# data ----
set.seed(43)
production <- c(12, 13, 14, 11, 10, 13, 14, 12, 11, 10, 10, 12, 12, 13, 14, 10, 14, 13, 10, 14,
    17, 13, 17, 14, 13, 13, 17, 14, 17, 13, 10, 9, 10, 12, 11, 9, 10, 12, 10, 11,
    11, 9, 11, 11, 12, 10, 9, 13, 11, 10, 13, 12, 11, 15, 14, 11, 15, 13, 14, 12) 
production <- round(production + rnorm(n = length(production), sd = 0.5), 1)

milk_production <- tibble(
  ration = ordered(rep(c("low", "high"), each = 30), levels = c("low", "high")), 
  feed = factor(rep(rep(c("hay", "grass", "maize silage"), each = 10), times = 2)), 
  milk = production)

milk_production <- labelise(milk_production, 
  label = list(ration = "Ration", feed = "Type d'alimentation", milk = "Quantit√© de lait"),
  units = list(milk = "L/J"))
```

```{r, echo=FALSE}
BioDataScience1::learnr_banner()
```

```{r, context="server"}
BioDataScience1::learnr_server(input, output, session)
```

## Objectifs

Lors de la r√©alisation du tutoriel pr√©c√©dent portant sur l'ANOVA √† un facteur, vous avez √©tudi√© une variable r√©ponse pour diff√©rents niveaux d'une variable facteur. Dans le [module 11](https://wp.sciviews.org/sdd-umons/?iframe=wp.sciviews.org/sdd-umons-2020/variance2.html) du cours, vous avez vu qu'il √©tait √©galement possible de consid√©rer deux variables facteurs avec une **ANOVA √† deux facteurs**. 

Ce tutoriel vous permettra d'auto-√©valuer votre aptitude √†\ :

- pr√©senter vos donn√©s avant une ANOVA √† deux facteurs

- effectuer une ANOVA √† deux facteurs 

- interpr√©ter correctement les r√©sultats obtenus

Assurez-vous d'avoir compris les sections [11.1](https://wp.sciviews.org/sdd-umons/?iframe=wp.sciviews.org/sdd-umons-2020/anova-%25C3%25A0-deux-facteurs.html), [11.2](https://wp.sciviews.org/sdd-umons/?iframe=wp.sciviews.org/sdd-umons-2020/mod%25C3%25A8le-sans-interactions.html) et [11.3](https://wp.sciviews.org/sdd-umons/?iframe=wp.sciviews.org/sdd-umons-2020/mod%25C3%25A8le-crois%25C3%25A9-complet.html) du cours. Vous devez √©galement maitriser les diff√©rentes notions vue dans le [module 10](https://wp.sciviews.org/sdd-umons/?iframe=wp.sciviews.org/sdd-umons-2020/variance.html) relatives √† l‚ÄôANOVA √† un facteur.

## Rendement laitier

Lors de ce tutoriel, vous allez r√©aliser une analyse visant √† √©tudier l'influence du type et de la quantit√© d'alimention sur le rendement laitier. 

![](images/rendement_laitier.jpg)

Le jeu de donn√©es `milk_production` comprend les variables suivantes\ :

- `ration`\ : la quantit√© d'alimentation apport√©e (low = ration faible ou high = ration √©lev√©e)
- `feed`\ : le type d'alimentation fourni (hay = foin, grass = herbe ou maize silage = ma√Øs ensil√©s)
- `milk`\ : la quantit√© de lait en L/jour

```{r}
glimpse(milk_production)
```

La question biologique √† laquelle vous allez essayer de r√©pondre est la suivante : **y a t'il une diff√©rence de rendement dans la production de lait en fonction de la ration et du type d'alimentation donn√©e aux vaches ?**

### Description graphique des donn√©es

Diff√©rents graphiques vous permettent de visualiser correctement les observations de votre jeu de donn√©es avant la r√©alisation de votre ANOVA √† deux facteurs. √Ä partir du jeu de donn√©es (`milk_production`), r√©alisez un premier graphique repr√©sentant la moyenne du rendement de la production de lait (`milk`) en fonction du type d'alimentation (`feed`) et en utilisant la couleur pour la quantit√© d'alimentation apport√©e (`ration`). 

```{r lait_graph_h2, exercise = TRUE}
chart(___, ___ ~ ___ %col=% ___) +
  geom_point(alpha = 0.4, position = position_dodge2(0.4, padding = 0.1)) +
  stat_summary(geom = "point", fun = "mean", position = position_dodge(0.4), size = 4)
```

```{r lait_graph_h2-hint-1}
chart(milk_production, ___ ~ feed %col=% ___) +
  geom_point(alpha = 0.4, position = position_dodge2(0.4, padding = 0.1)) +
  stat_summary(geom = "point", fun = "mean", position = position_dodge(0.4), size = 4)

 #### ATTENTION: Hint suivant = solution !####
```

```{r lait_graph_h2-solution}
chart(milk_production, milk ~ feed %col=% ration) +
  geom_point(alpha = 0.4, position = position_dodge2(0.4, padding = 0.1)) +
  stat_summary(geom = "point", fun = "mean", position = position_dodge(0.4), size = 4)
```

```{r lait_graph_h2-check}
grade_code("Le graphique que vous venez de r√©alisez permet de comparer le rendement laitier en fonction de la ration par types d'alimentation. Le choix du nuage de point avec l'ajout de la moyenne est tout indiqu√© lorsque le nombre d'observations est faible. Les aliments ensil√©s permettent d'avoir mettent en avant une production plus importante de lait par jour.")
```

### Visualisation graphique des interactions 

Dans un mod√®le d'ANOVA √† deux facteurs, il faut aussi consid√©rer que l'effet d'un facteur sur la variable explicative peut-√™tre diff√©rent suivant les modalit√©s de l'autre facteur mis en jeu. On parle alors d'interactions. Il est possible de les explorer en r√©alisant un graphique des interactions qui vous permettra de visualiser les √©carts des moyennes respectives des diff√©rentes sous-populations. 

R√©alisez sur le jeu de donn√©es `milk_production` le graphique permettant de visualiser les interactions entre les variables facteurs (`feed` et `ration`). Commencez par calculer la moyenne du rendement par types d'alimentation et par ration. R√©alisez ensuite un graphique du rendement moyen en fonction des rations par types d'alimentation en reliant les points des moyennes par des lignes pour chaque type d'alimentation. 


```{r interaction_h3, exercise = TRUE}
___ %>.%
  ___(., ___, ___) %>.% 
  ___(., milk_mean = ___(___)) %>.%  # moyenne du rendement 
  chart(data = ___, ___ ~ ___ %col=% ___ %group=% ___) + # graphique du rendement moyen en fonction de la quantit√© d'aliment par type
  ___() + # lignes
  ___() # points
```

```{r interaction_h3-hint-1}
DF %>.%
  group_by(., FACTOR1, FACTOR2) %>.% # regroupement par type d'alimentation et par ration
  summarise(., milk_mean = mean(VARNUM)) %>.%   # moyenne du rendement 
  chart(data = ___, ___ ~ ___ %col=% ___ %group=% ___) + # graphique du rendement moyen en fonction de la quantit√© d'aliment par type
  ___() + # lignes
  # points
  ___()
```

```{r interaction_h3-hint-2}
milk_production %>.%
  group_by(., feed, ration) %>.% # regroupement par type et quantit√© d'alimentation
  summarise(., milk_mean = mean(milk)) %>.% # moyenne du rendement 
  chart(data = ., VARNUM ~ FACTOR1 %col=% FACTOR2 %group=% FACTOR2) +
  ___() + # lignes
  ___() # points

 #### ATTENTION: Hint suivant = solution !####
```

```{r interaction_h3-solution}
milk_production %>.%
  group_by(., feed, ration) %>.% # regroupement par type et quantit√© d'alimentation
  summarise(., milk_mean = mean(milk)) %>.%  # moyenne du rendement 
  chart(data = ., milk_mean ~ feed %col=% ration %group=% ration) + 
  geom_line() + # lignes
  geom_point() # points
```

```{r interaction_h3-check}
grade_code("Ce graphique permet d'analyser les interactions entre les pr√©dicteurs (rations et types d'alimentation) et la r√©ponse (rendement laitier). Lorsque les lignes sont parall√®les, il n'y a pas d'interaction √† l'inverse, lorsque les lignes ne sont pas parall√®les, il existe probablement une interaction. Moins les lignes sont parall√®les plus l'interaction sera forte. Dans notre cas, nous serions tent√© de penser qu'il n'y a pas d'int√©ractions. Cependant, il reste plus sur de r√©aliser un mod√®le crois√© complet dans un premier temps. Puis de r√©aliser un mod√®le crois√© sans int√©ractions si cela se justifie.")
```

### Description num√©rique sous la forme d'un tableau

Vous pouvez √©galement r√©sumer vos donn√©es sous la forme d'un tableau. √Ä partir du jeu de donn√©es `milk_production`, r√©alisez un tableau de r√©sum√© contenant la moyenne et  l'√©cart-type du rendement de la production de lait (`milk`) par type d'alimentation (`feed`) et par quantit√© des rations (`ration`). Ajoutez √©galement le nombre d'observation par sous-groupe. 

üí¨ **Le code ci-dessous correspond au snippet `.hmanova2desc`.**

```{r lait_tab_h2, exercise=TRUE}
___ %>.%
  group_by(., ___, ___) %>.%
  summarise(., mean = mean(___), sd = sd(___), count = sum(!is.na(___)))
```

```{r lait_tab_h2-hint-1}
DF %>.%
  group_by(., XFACTOR1, XFACTOR2) %>.%
  summarise(., mean = mean(YNUM), sd = sd(YNUM), count = sum(!is.na(YNUM)))

 #### ATTENTION: Hint suivant = solution !####
```

```{r lait_tab_h2-solution}
milk_production %>.%
  group_by(., feed, ration) %>.%
  summarise(., mean = mean(milk), sd = sd(milk), count = sum(!is.na(milk)))
```

```{r lait_tab_h2-check} 
grade_code("Le tableau que vous avez obtenu est parfait pour pr√©senter vos r√©sultats avant de r√©aliser une ANOVA √† deux facteurs. Attention, ce tableau est en anglais. N'oubliez pas de le traduire si votre rapport est en fran√ßais.")
```

Les graphiques et la tableau r√©sumant des donn√©es que vous venez de r√©aliser vous ont permis de prendre connaissance des donn√©es sur lesquelles vous travaillez. Vous allez maintenant pouvoir passer √† la r√©alisation de votre test d'hypoth√®se. Vous commencez maintenant √† avoir l'habitude, avant de pouvoir le r√©aliser, vous allez devoir v√©rifier si les conditions d'application du test sont respect√©es. 

### V√©rification des conditions d'applications

Si vous souhaitez r√©aliser une ANOVA √† deux facteurs, vous devez respecter les conditions d'application suivantes\ :

- √©chantillon repr√©sentatif,
- observations ind√©pendantes,
- une variable r√©ponse quantitative,
- deux variables explicatives qualitatives √† deux niveaux ou plus,
- distribution **normale** des r√©sidus,
- **homosc√©dasticit√©** (m√™me variance intragroupe).

Pour v√©rifier si l'√©chantillonage est repr√©sentatif de la population et si les observations sont bien ind√©pendantes les unes des autres, vous pouvez vous r√©f√©rer au protocole exp√©rimental. Dans le cas de cette √©tude, les individus ont bien √©t√© s√©lectionn√©s par un processus al√©atoire. L'attribution des niveaux de la ration et du type d'alimentation a √©galement √©t√© r√©alis√©e de mani√®re al√©atoire. 

Le type de variable peut se v√©rifier en consultant les donn√©es. Attention de bien vous assurer que les deux variables explicatives que vous utilisez sont bien de type facteur non ordonn√© (`factor`) ou facteur ordonn√© (`ordered`) dans R.  

Vous allez maintenant pouvoir v√©rifier les deux derni√®res conditions sur votre √©chantillon. Les donn√©es par sous-population √©tant en nombre suffisant, vous allez pouvoir appliquer un test permetant de v√©rifier l'homosc√©dasticit√© des variances. Vous devrez aussi v√©rifier que la distribution des r√©sidus suit bien une distribution Normale. Cette √©tape se fait apr√®s la r√©alisation du test de l'ANOVA √† deux facteurs mais avant son interpr√©tation. 

### Test de Bartlett

Pour √©valuer l'homosc√©dasticit√© de vos donn√©es, vous allez utiliser le test de Bartlett. Afin d'interpr√©ter correctement le test que vous allez r√©aliser, commencez par poser les hypoth√®ses de d√©part. Le test de Barlett doit se faire sur toutes les sous-populations. Pour cela, vous pouvez utiliser la fonction `interaction()` en lui renseignant les variables explicatives. Cette fonction, qui calculera pour vous tous les sous-groupe possible, peut directement √™tre utils√©e dans la formule. 

R√©alisez un test de bartlett avec interaction sur les donn√©es du jeu `milk_production` de la quantit√© de lait (`milk`) en fonction du type d'alimentation (`feed`) et de la ration (`ration`) .

üí¨ **Le code ci-dessous correspond au snippet `.hvbartlett`.**

```{r lait_bart_h2, exercise = TRUE}
bartlett.test(data = ___, ___ ~ ___(___, ___))
```

```{r lait_bart_h2-hint-1}
bartlett.test(data = DF, YNUM ~ interaction(XFACTOR1, XFACTOR2))

 #### ATTENTION: Hint suivant = solution !####
```

```{r lait_bart_h2-solution}
bartlett.test(data = milk_production, milk ~ interaction(feed, ration))
```

```{r lait_bart_h2-check}
grade_code("Vous avez correctement r√©aliser l'instruction R pour ce test. Saurez-vous l'interpr√©ter correctement en r√©pondant √† la question suivante ? ")
```

```{r lait_bart_quiz}
question("Au seuil alpha de 5%, y a t'il homosc√©dasticit√© ?",
         answer("Oui", correct = TRUE),
         answer("Non"),
         allow_retry = TRUE,
         random_answer_order = TRUE,
         incorrect = "Avez-vous bien d√©fini les hypoth√®ses H0 et H1 de votre test de Bartlett ?",
         correct = "Bravo, c'est correct. La valeur de p que vous avez obtenue √©tant plus grande que le seuil alpha de 5%, vous ne rejettez donc pas H0 et pouvez consid√©rer qu'il y a homosc√©dasticit√©.")
```

## Anova √† 2 facteurs

### Anova √† 2 facteurs avec interactions

Vous allez maintenant pouvoir r√©aliser une ANOVA √† 2 facteurs avec interaction.

Comme pour l'ANOVA √† un facteur, vous allez utiliser la fonction `lm()` qui demande un jeu de donn√©es et une formule avant de lui appliquer la m√©thode `anova()` afin de produire le tableau de l'analyse de la variance.

Le mod√®le crois√© avec interactions peut s'√©crire de 2 mani√®res dans R.

```{r, echo=TRUE, eval=FALSE}
anova(anova. <- lm(data = DF, YNUM ~ XFACTOR1 + XFACTOR2 + XFACTOR1:XFACTOR2))
```

o√π `XFACTOR1:XFACTOR2` repr√©sente le terme correspondant √† l'interaction. 

Ce mod√®le peut aussi se simplifier en utilisant `*` √† la place du `+` entre les deux variables facteurs ce qui signifiera implicitement de tenir compte des interactions. Cela donne, 

```{r, echo=TRUE, eval=FALSE}
anova(anova. <- lm(data = DF, YNUM ~ XFACTOR1 * XFACTOR2))
```

R√©alisez votre mod√®le ANOVA √† deux facteurs avec interactions sur le rendement de lait en fonction du type d'alimentation et de la ration.

üí¨ **Le code ci-dessous correspond au snippet `.hmanova2`**.

```{r lait_interaction_h2, exercise = TRUE}
anova(anova. <- lm(data = ___, ___ ~ ___ * ___))
```

```{r lait_interaction_h2-hint-1}
anova(anova. <- lm(data = milk_production, ___ ~ ___ * ___))

 #### ATTENTION: Hint suivant = solution !####
```

```{r lait_interaction_h2-solution}
anova(anova. <- lm(data = milk_production, milk ~ feed * ration))
```

```{r lait_interaction_h2-check}
grade_code("Bravo, vous avez encod√© correctement votre mod√®le. N'oubliez pas qu'avant de pouvoir interpr√©ter vos r√©sultats vous devez v√©rifier la normalit√© des r√©sidus. Dans cette analyse, les r√©sidus suivent une distribution normale, les conditions de votre ANOVA √† deux facteurs sont donc remplies. Vous pouvez interpr√©ter vos r√©sultats en r√©pondant √† la question ci-dessous.")
```

```{r lait_interaction_quiz}
question("Y a t'il une int√©raction significative entre les rations et les types d'alimention au seuil alpha de 5% ?",
     answer("oui"),
     answer("non", correct = TRUE),
     allow_retry = TRUE,
     incorrect = "L'interpr√©tation que vous avez faite n'est pas la bonne. Retournez voir dans le cours comment se prend la d√©cision du rejet ou non de H0 en comparant la valeur de p obtenue au seuil alpha 5%.",
     correct = "Bravo, c'est correct. Il n'y a pas d'interactions entre les 2 facteurs. Avant de continuez l'analyse, vous allez simplifier le mod√®le en retirant le terme correspondant √† l'interaction.")
```

### Anova √† 2 facteurs sans interactions

Lorsque vous n'avez pas d'interactions, vous pouvez simplifier votre mod√®le en supprimant le terme correspondant √† l'interaction. Votre mod√®le s'√©crit donc de cette mani√®re. 

```{r, echo=TRUE, eval=FALSE}
anova(anova. <- lm(data = DF, YNUM ~ XFACTOR1 + XFACTOR2))
```

R√©alisez votre mod√®le ANOVA √† deux facteurs sans interactions sur le rendement de lait en fonction de la ration et du type d'alimentation.

üí¨ **Le code ci-dessous correspond au snippet `.hmanova2noint`**.

```{r lait_croise_h2, exercise = TRUE}
anova(anova. <- lm(data = ___, ___ ~ ___ + ___))
```

```{r lait_croise_h2-hint-1}
anova(anova. <- lm(data = lait, ___ ~ ___ + ___))

 #### ATTENTION: Hint suivant = solution !####
```

```{r lait_croise_h2-solution}
anova(anova. <- lm(data = milk_production, milk ~ feed + ration))
```

```{r lait_croise_h2-check}
grade_code("Bravo, vous avez r√©ussi √† simplifier votre mod√®le. Dans cette analyse, les r√©sidus suivent √©galement une distribution normale, les conditions de votre ANOVA √† deux facteurs sont donc √©galement remplies. Vous pouvez interpr√©ter vos r√©sultats en r√©pondant aux questions ci-dessous.")
```

```{r lait_croise_quiz}
quiz(question("Y a t'il une diff√©rence significative entre les deux rations au seuil alpha de 5% ?",
     answer("oui", correct = TRUE),
     answer("non"),
     allow_retry = TRUE,
     incorrect = "L'interpr√©tation que vous avez faite n'est pas la bonne. Retournez voir dans le cours comment se prend la d√©cision du rejet ou non de H0 en comparant la valeur de p obtenue au seuil alpha 5%.",
     correct = "Votre interpr√©tation est correct, il y a bien une diff√©rence significative, au seuil alpha de 5%, entre les rations donn√©es sur le rendement de lait."),
     question("Y a t'il une diff√©rence significative entre les trois types d'alimentation au seuil alpha de 5% ?",
     answer("oui", correct = TRUE),
     answer("non"),
     allow_retry = TRUE,
     incorrect = "L'interpr√©tation que vous avez faite n'est pas la bonne. Retournez voir dans le cours comment se prend la d√©cision du rejet ou non de H0 en comparant la valeur de p obtenue au seuil alpha 5%.",
     correct = "Votre interpr√©tation est correct, il y a bien une diff√©rence significative, au seuil alpha de 5%, entre les types d'alimentation donn√©s sur le rendement de lait.")
     )
```

## Tests post-hoc

Votre ANOVA √† 2 facteurs sans interactions indique qu'il y a une diff√©rence significative entre les rations donn√©es et qu'il y a au moins une des moyennes qui est significativement diff√©rente des autres au seuil $\alpha$ de 5% pour le type d'alimentation. Un test post-hoc de comparaisons multiples vous permettra d'avoir plus de pr√©cision. 

üí¨ **Ce code correspond au snippet `.hmanovamult`**

```{r lait_prepa}
anova. <- lm(data = milk_production, milk ~ feed + ration)
```

```{r lait_post_h2, exercise = TRUE, exercise.setup = "lait_prepa"}
summary(anovaComp. <- confint(multcomp::glht(anova.,
  linfct = multcomp::mcp(___ = "Tukey", ___ = "Tukey")))) # Add a second factor if you want
.oma <- par(oma = c(0, 5.1, 0, 0)); plot(anovaComp.); par(.oma); rm(.oma)
```

```{r lait_post_h2-hint-1}
summary(anovaComp. <- confint(multcomp::glht(anova.,
  linfct = multcomp::mcp(XFACTOR1 = "Tukey", XFACTOR2 = "Tukey")))) # Add a second factor if you want
.oma <- par(oma = c(0, 5.1, 0, 0)); plot(anovaComp.); par(.oma); rm(.oma)

 #### ATTENTION: Hint suivant = solution !####
```

```{r lait_post_h2-solution}
summary(anovaComp. <- confint(multcomp::glht(anova.,
  linfct = multcomp::mcp(feed = "Tukey", ration = "Tukey")))) # Add a second factor if you want
.oma <- par(oma = c(0, 5.1, 0, 0)); plot(anovaComp.); par(.oma); rm(.oma)
```

```{r lait_post_h2-check}
grade_code("Le test de comparaison n'est pas vraiment n√©cessaire dans le cas de la variable ration puisque vous n'avez que 2 niveaux. Mais cela vous permet de voir comment proc√©der lorsque le nombre de niveaux est plus important. Par contre, il prend tout son sens dans le cas de la variable alimentation pour identifier les paires de moyennes qui sont diff√©rentes. Identifiez les niveaux qui sont significativement diff√©rents en r√©pondant √† la question suivante.")
```

```{r lait_post_quiz}
question("Quels sont les niveaux significativement diff√©rents au seuil alpha de 5% ?",
         answer("foin par rapport √† aliments ensil√©s", correct = TRUE),
         answer("herbe par rapport √† aliments ensil√©s", correct = TRUE),
         answer("herbe par rapport √† foin", correct = FALSE), 
  allow_retry = TRUE, correct = "Tr√®s bien ! En effet, la moyennes des aliments ensil√©s est diff√©rentes de celle du foin ou de l'herbe.",
  incorrect = "Votre r√©ponse est peut-√™tre incompl√®te ou vous avez commis une erreur dans l'interpr√©tation. Regardez bien le tableau et le graphique issus de l'analyse post hoc.")
```

## Conclusion

F√©licitation ! Vous avez r√©alis√© une ANOVA √† deux facteurs compl√®te. N'oubliez pas de bien v√©rifier vos conditions d'application de test avant d'interpr√©ter vos r√©sultats. N'h√©sitez pas √† simplifier votre mod√®le lorsque cela s'av√®re n√©cessaire.


```{r comm_noscore, echo=FALSE}
question_text(
  "Laissez-nous vos impressions sur cet outil p√©dagogique",
  answer("", TRUE, message = "Pas de commentaires... C'est bien aussi."),
  incorrect = "Vos commentaires sont enregistr√©s.",
  placeholder = "Entrez vos commentaires ici...",
  allow_retry = TRUE
)
```
