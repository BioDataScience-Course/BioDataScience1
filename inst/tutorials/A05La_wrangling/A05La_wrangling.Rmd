---
title: "Remaniement de données"
author: "Guyliann Engels & Philippe Grosjean"
description: "**SDD I Module 5** Remanier des données dans R."
tutorial:
  id: "A05La_wrangling"
  version: 2.1.0/3
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
    fig_caption: yes
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
BioDataScience1::learnr_setup()
SciViews::R()
library(BioDataScience)

# Dataset
crabs <- read("crabs", package = "MASS", lang = "fr")
```

```{r, echo=FALSE}
BioDataScience1::learnr_banner()
```

```{r, context="server"}
BioDataScience1::learnr_server(input, output, session)
```

------------------------------------------------------------------------

## Objectifs

-   Vérifier la compréhension des fonctions servant au remaniement des données avec les fonctions `select()`/`sselect()`, `filter()`/`sfilter()`, `mutate()`/`smutate()`, `group_by()`/`sgroup_by()`, `summarise()`/`ssummarise()`
-   Vérifier l'acquisition des compétences relatives au chaînage des instructions

## Calculer de nouvelles variables

Le remaniement des données est indispensable lors d'une analyse. Pour vérifier l'acquisition de ces compétences, le jeu de données sur la mesure de deux espèces de crabes est employé.

```{r}
SciViews::R
# Importation des données crabs
(crabs <- read("crabs", package = "MASS", lang = "fr"))
```

À partir du jeu de données `crabs`, calculez à l'aide de la fonction speedy `smutate()` :

-   le logarithme (`log()`) de la longueur de la carapace (`length`) des crabes et nommez cette nouvelle variables **length_log**
-   la racine carrée (`sqrt()`) de la largueur de la carapace (`width`) et nommez cette nouvelle variable **width_sqrt**
-   Divisez la variable lobe frontal (`front`) par 1000 et nommez cette nouvelle variable **front_m**

Affichez ensuite les premières lignes du tableau (`head()`). Par défaut, les 6 premières lignes sont affichées). Vous devez obtenir le tableau ci-dessous :

```{r}
crabs <- smutate(crabs, 
  length_log = log(length),
  width_sqrt = sqrt(width),
  front_m    = front / 1000)
# Visualisation des premières lignes du tableau 
head(crabs)
```

```{r mutate_h3, exercise=TRUE}
___ <- ___(___,
  ___ = ___,
  ___ = ___,
  ___ = ___)
# Visualisation des premières lignes du tableau 
___(___)
```

```{r mutate_h3-hint-1}
DF <- smutate(___,
  length_log = ___,
  width_sqrt = ___,
  front_m    = ___)
# Visualisation des premières lignes du tableau 
head(___)
```

```{r mutate_h3-hint-2}
crabs <- smutate(crabs,
  length_log = log(___),
  width_sqrt = sqrt(___),
  front_m    = ___ / 1000)
# Visualisation des premières lignes du tableau 
head(___)

#### Attention : solution dans le 'hint' suivant! ####
```

```{r mutate_h3-solution}
## Solution ##
crabs <- smutate(crabs,
  length_log = log(length),
  width_sqrt = sqrt(width),
  front_m    = front / 1000)
# Visualisation des premières lignes du tableau 
head(crabs)
```

```{r mutate_h3-check}
grade_code("Vous savez maintenant comment calculer de nouvelles variables avec la fonction `smutate()`.")
```

## Filtrer et sélectionner des données

Reprenons le jeu de données initial sur nos crabes (`crabs`).

```{r}
# Importation des données sur nos crabes
(crabs <- read("crabs", package = "MASS", lang = "fr"))
```

Réalisez les opérations suivantes avec les fonctions tidy `filter()` et `select()` :

-   Retirer la variable index (`index`) du jeu de données
-   Garder uniquement les individus mâles du jeu de données dont la longueur de la carapace est supérieure ou égale à 25 mm (variables `sex` et `length`)
-   Enregistrez le résultat dans `crabs2`
-   Affichez ensuite les premières lignes du tableau `crabs2`

Employez le chaînage des instructions dans un pipeline pour résoudre cette exercice. Vous devez obtenir le tableau ci-dessous :

```{r}
crabs %>.%
  select(., -index) %>.%
  filter(., sex == "M" & length >= 25) %->%
  crabs2
head(crabs2)
```

```{r pipe1_h3, exercise=TRUE}
crabs ___
  ___(___, ___) ___
  ___(___, ___ & ___) ___
  ___
___(___)
```

```{r pipe1_h3-hint-1}
crabs %>.%
  select(___, ___) ___
  filter(___, ___ & ___) ___
  ___
head(___)
```

```{r pipe1_h3-hint-2}
crabs %>.%
  select(., - ___) %>.%
  filter(___, sex == ___ & length >= ___) ___
  ___
head(___)

#### Attention : solution dans le 'hint' suivant! ####
```

```{r pipe1_h3-solution}
## Solution ##
crabs %>.%
  select(., -index) %>.%
  filter(., sex == "M" & length >= 25) %->%
  crabs2
head(crabs2)
```

```{r pipe1_h3-check}
grade_code("La sélection de vos variables avec `select()` et de vos observations avec `filter()` (fonctions tidy) nécessite de collecter le résultat soit avec collect_dtx(), soit en utilisant l'assignation alternative %<-%  ou %->% . En général dans un pipeline, finnissez toujours en assignant avec %->%, quelles que soient les fonctions utilisées.")
```

## Résumer des données

Reprenons le jeu de données initial `crabs`.

```{r}
# Importation des données sur les crabes
(crabs <- read("crabs", package = "MASS", lang = "fr"))
```

Réalisez les opérations suivantes :

-   Sélectionnez les individus dont la longueur (`length`) est strictement supérieur à 25 mm
-   Résumez le jeu de données par le sexe (`sex`) et par la variété (`species`) de ce crabe dans cet ordre
    -   Calculez la moyenne de la largeur des carapaces (`width`) par groupe
    -   Dénombrez les individus par groupe (y compris les valeurs manquantes)
    -   Dénombrez les observations par groupe (à l'exclusion des valeurs manquantes)
-   Assignez le résultat à `crabs2`
-   Formatez votre tableau `crabs2` avec la fonction `knitr::kable()`

Employez des fonction speedy et fstat uniquement et le chaînage des opérations dans un pipeline pour résoudre cette exercice. Vous devez obtenir le tableau ci-dessous :

```{r}
crabs %>.%
  sfilter(., length > 25) %>.%
  sgroup_by(., sex, species) |> ssummarise(
    mean         = fmean(width),
    number       = fn(width),
    observations = fnobs(width)) %->%
  crabs2
knitr::kable(crabs2)
```

```{r pipe2_h3, exercise=TRUE}
crabs ___
  ___(___, ___) ___
  ___(___, ___, ___) ___ ___
    mean         = ___(___),
    number       = ___(___),
    observations = ___(___)) ___
  ___
  ___(___)
```

```{r pipe2_h3-hint-1}
crabs %>.%
  sfilter(___, ___) ___
  sgroup_by(___, ___, ___) ___ ssummarise(
    mean         = ___(___),
    number       = ___(___),
    observations = ___(___)) ___
  ___
kintr::kable(___)
```

```{r pipe2_h3-hint-2}
crabs %>.%
  sfilter(., length > ___) %>.%
  sgroup_by(., ___, ___) |> ssummarise(
    mean         = fmean(___),
    number       = fn(___),
    observations = fnobs(___)) ___
  ___
knitr::kable(___)

#### Attention : solution dans le 'hint' suivant! ####
```

```{r pipe2_h3-solution}
## Solution ##
crabs %>.%
  sfilter(., length > 25) %>.%
  sgroup_by(., sex, species) |> ssummarise(
    mean         = fmean(width),
    number       = fn(width),
    observations = fnobs(width)) %->%
  crabs2
knitr::kable(crabs2)
```

```{r pipe2_h3-check}
grade_code("Vous avez maintenant compris comment résumer vos données avec `(s)group_by()` et `(s)summarise()` et formater vos sorties avec `knitr::kable()`. Utilisez toujours l'assignation alternative `%->%` en fin de pipeline, c'est plus prudent.")
```

## Conclusion

Bravo ! Vous venez de terminer votre séance d'exercices relative à la manipulation des données.

Vous maîtriser maintenant :

-   les notions relatives aux remaniement des données avec les fonctions `(s)select()`, `(s)filter()`, `(s)mutate()`, `(s)group_by()`, `(s)summarise()`
-   le chaînages des instructions dans un pipeline
-   l'utilisation judicieuse de `%>.%` pour indiquer que l'on passe à l'opération suivante
-   l'utilisation de `|>` pour organiser le code plus complexe sur un même niveau (typiquement un `(s)group_by()` suivi d'un `(s)summarise()`)
-   l'assignation alternative `%->%` en fin de pipeline tidy pour collecter les résultats dans un tableau

```{r comm_noscore, echo=FALSE}
question_text(
  "Laissez-nous vos impressions sur ce learnr",
  answer("", TRUE, message = "Pas de commentaires... C'est bien aussi."),
  incorrect = "Vos commentaires sont enregistrés.",
  placeholder = "Entrez vos commentaires ici...",
  allow_retry = TRUE
)
```
